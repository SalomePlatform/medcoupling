# Copyright (C) 2005  OPEN CASCADE, CEA, EDF R&D, LEG
#           PRINCIPIA R&D, EADS CCR, Lip6, BV, CEDRAT
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either 
# version 2.1 of the License.
# 
# This library is distributed in the hope that it will be useful 
# but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU 
# Lesser General Public License for more details.
# 
# You should have received a copy of the GNU Lesser General Public  
# License along with this library; if not, write to the Free Software 
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
# 
# See http://www.salome-platform.org/ or email : webmaster.salome@opencascade.com
# 
# -* Makefile *- 
#
# Author : Nadir BOUHAMOU (CEA)
#

# source path
top_srcdir=@top_srcdir@
top_builddir=../..
srcdir=@srcdir@
VPATH=.:@srcdir@
doxygen=@DOXYGEN@

@COMMENCE@

# Executables targets
BIN = MESHgeneral MESHcoordinates MESHconnectivities MESHINGexample FIELDcreate FIELDgeneral MEDMEM_InvokingDriverByAttachingItToAnObject MEDMEM_InvokingDriverFromStandardObjectMethod MEDMEM_InvokingDriverAtObjectCreationTime 

LDFLAGS+= -L$(top_builddir)/lib@LIB_LOCATION_SUFFIX@/salome 
LDFLAGSFORBIN+= -L$(top_builddir)/lib@LIB_LOCATION_SUFFIX@/salome

CPPFLAGS+=$(MED2_INCLUDES) $(HDF5_INCLUDES)

CXXFLAGS+=@CXXTMPDPTHFLAGS@
#LDFLAGS+=$(MED2_LIBS) $(HDF5_LIBS)
# change motivated by the bug KERNEL4778.
LDFLAGS+=$(MED2_LIBS) $(HDF5_LIBS) -lmedmem -lmed_V2_1 $(STDLIB)

#LDFLAGSFORBIN+=$(MED2_LIBS) $(HDF5_LIBS)
# change motivated by the bug KERNEL4778.
LDFLAGSFORBIN+=-lm $(MED2_LIBS) $(HDF5_LIBS) -lmedmem -lmed_V2_1

ifeq ($(MED_WITH_KERNEL),yes)
  CPPFLAGS+= ${KERNEL_CXXFLAGS}
  CXXFLAGS+= ${KERNEL_CXXFLAGS}
  LDFLAGS+= ${KERNEL_LDFLAGS} -lSALOMELocalTrace 
  LDFLAGSFORBIN+= ${KERNEL_LDFLAGS} -lSALOMELocalTrace -lSALOMEBasics
endif

LIBSFORBIN=

LIBS=

@CONCLUDE@

doc: .doxygen_user .doxygen_devel ps

ps: .doxygen_user .doxygen_devel MedMemory_user.ps MedMemory_devel.ps MEDMEM_UsersGuide.ps

ps_2on1: .doxygen_user .doxygen_devel MedMemory_user_2on1.ps MedMemory_devel_2on1.ps MEDMEM_UsersGuide_2on1.ps

pdf: .doxygen_user .doxygen_devel MedMemory_user.pdf MedMemory_devel.pdf MEDMEM_UsersGuide.pdf

pdf_2on1: .doxygen_user .doxygen_devel MedMemory_user_2on1.pdf MedMemory_devel_2on1.pdf MEDMEM_UsersGuide_2on1.pdf

# user doc :

.doxygen_user: $(top_srcdir)/src/MEDMEM/Doxyfile_med_user.in
	cd $(top_builddir) ; ./config.status
	cd $(top_builddir)/src/MEDMEM && $(doxygen) Doxyfile_med_user
	touch $@
	$(RM) -r doc_ref_user
	ln -s $(top_builddir)/src/MEDMEM/doc_ref_user doc_ref_user

MedMemory_user.ps:
	cd ./doc_ref_user/latex && $(MAKE) ps
	cp -f ./doc_ref_user/latex/refman.ps $@

MedMemory_user_2on1.ps:
	cd ./doc_ref_user/latex && $(MAKE) ps_2on1
	cp -f ./doc_ref_user/latex/refman_2on1.ps $@

MedMemory_user.pdf:
	cd ./doc_ref_user/latex && $(MAKE) pdf
	cp -f ./doc_ref_user/latex/refman.pdf $@

MedMemory_user_2on1.pdf:
	cd ./doc_ref_user/latex && $(MAKE) pdf_2on1
	cp -f ./doc_ref_user/latex/refman_2on1.pdf $@

# developper doc

.doxygen_devel: $(top_srcdir)/src/MEDMEM/Doxyfile_med_devel.in
	cd $(top_builddir) ; ./config.status
	cd $(top_builddir)/src/MEDMEM && $(doxygen) Doxyfile_med_devel
	touch $@
	$(RM) -r doc_ref_devel
	ln -s $(top_builddir)/src/MEDMEM/doc_ref_devel doc_ref_devel

MedMemory_devel.ps:
	cd ./doc_ref_devel/latex && $(MAKE) ps
	cp -f ./doc_ref_devel/latex/refman.ps $@

MedMemory_devel_2on1.ps:
	cd ./doc_ref_devel/latex && $(MAKE) ps_2on1
	cp -f ./doc_ref_devel/latex/refman_2on1.ps $@

MedMemory_devel.pdf:
	cd ./doc_ref_devel/latex && $(MAKE) pdf
	cp -f ./doc_ref_devel/latex/refman.pdf $@

MedMemory_devel_2on1.pdf:
	cd ./doc_ref_devel/latex && $(MAKE) pdf_2on1
	cp -f ./doc_ref_devel/latex/refman_2on1.pdf $@

# User Guide

MEDMEM_UsersGuide.ps: MEDMEM_UsersGuide.pdf
	pdf2ps MEDMEM_UsersGuide.pdf MEDMEM_UsersGuide.ps 

MEDMEM_UsersGuide_2on1.ps: MEDMEM_UsersGuide.ps
	psnup -2 MEDMEM_UsersGuide.ps >MEDMEM_UsersGuide_2on1.ps

MEDMEM_UsersGuide_2on1.pdf: MEDMEM_UsersGuide_2on1.ps
	ps2pdf MEDMEM_UsersGuide_2on1.ps MEDMEM_UsersGuide_2on1.pdf

MEDMEM_UsersGuide.pdf: MEDMEM_UsersGuide.tex MEDMEM_Content.tex MEDMEM_UML_light.png MEDMEM_UML.png FIELDcreate.cxx FIELDgeneral.cxx MEDMEM_InvokingDriverAtObjectCreationTime.cxx MEDMEM_InvokingDriverByAttachingItToAnObject.cxx MEDMEM_InvokingDriverFromStandardObjectMethod.cxx MEDMEM_MedAddingAnExistingObject.cxx MESHconnectivities.cxx MESHcoordinates.cxx MESHgeneral.cxx MESHINGexample.cxx FIELDcreate.py FIELDgeneral.py MEDMEM_InvokingDriverAtObjectCreationTime.py MEDMEM_InvokingDriverByAttachingItToAnObject.py MEDMEM_InvokingDriverFromStandardObjectMethod.py MESHconnectivities.py MESHcoordinates.py MESHgeneral.py MESHINGexample.py
	echo "Running pdflatex..."
	pdflatex $<
	#echo "Running makeindex..."
	#makeindex MEDMEM_UsersGuide.idx
	echo "Rerunning latex...."
	pdflatex $<
	latex_count=5
	while egrep -s 'Rerun (LaTeX|to get cross-references right)' MEDMEM_UsersGuide.log && [ $latex_count -gt 0 ] ;\
	    do \
	      echo "Rerunning latex...." ;\
	      latex $< ;\
	      latex_count=`expr $latex_count - 1` ;\
	    done

MEDMEM_UsersGuide.tex:MEDMEM_UsersGuide.tex.in
	cd $(top_builddir) && CONFIG_FILES=./doc/MEDMEM/MEDMEM_UsersGuide.tex ./config.status

MEDMEM_Content.tex:MEDMEM_Content.tex.in
	cd $(top_builddir) && CONFIG_FILES=./doc/MEDMEM/MEDMEM_Content.tex ./config.status 

MEDMEM_UML_light.png:MEDMEM_UML_light.png.in
	cd $(top_builddir) && CONFIG_FILES=./doc/MEDMEM/MEDMEM_UML_light.png ./config.status 

MEDMEM_UML.png:MEDMEM_UML.png.in
	cd $(top_builddir) && CONFIG_FILES=./doc/MEDMEM/MEDMEM_UML.png ./config.status 

# install procedure

install: $(datadir)/doc ps_2on1 pdf_2on1
	$(RM) -r $(datadir)/doc/html_ref_user $(datadir)/doc/html_ref_devel $(datadir)/doc/*.ps $(datadir)/doc/*.pdf
	cp -rf ./doc_ref_user/html $(datadir)/doc/html_ref_user
	cp -rf ./doc_ref_devel/html $(datadir)/doc/html_ref_devel
	cp -f MedMemory_user_2on1.ps MedMemory_user_2on1.pdf $(datadir)/doc
	cp -f MEDMEM_UsersGuide_2on1.ps MEDMEM_UsersGuide_2on1.pdf $(datadir)/doc
	cp -f MedMemory_devel_2on1.ps MedMemory_devel_2on1.pdf $(datadir)/doc

$(datadir)/doc:
	$(INSTALL) -d $@ && chmod 755 $@

cleandoc:
	-$(RM) -r *pdf *ps doc_ref_* $(top_builddir)/src/MEDMEM/doc_ref_* .dep*
